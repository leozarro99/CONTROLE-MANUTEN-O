<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Placas e Filiais</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a fonte Inter para todo o corpo */
        body {
            font-family: "Inter", sans-serif;
        }
        /* Animação para mensagens */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-down {
            animation: fadeInDown 0.3s ease-out forwards;
        }
    </style>
</head>
<body>
    <noscript>Você precisa habilitar o JavaScript para rodar este aplicativo.</noscript>
    <div id="root">
        <!-- O seu aplicativo React será montado aqui -->
    </div>

    <!-- React CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel CDN para transformar JSX no navegador (apenas para desenvolvimento/ambientes simples) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- XLSX CDN para exportação de Excel -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <script type="text/babel">
        // Importa o cliente Supabase
        const { createClient } = Supabase; // Supabase é globalmente disponível via CDN

        // Importação dos ícones do Lucide React (disponíveis globalmente via unpkg.com/lucide@latest)
        // Para usar os componentes Lucide React, eles precisariam ser importados diretamente ou registrados globalmente.
        // No contexto de um único arquivo HTML com Babel, vamos simular a disponibilidade dos ícones diretamente.
        // No entanto, para um projeto React real, você importaria os componentes Lucide React como no código App.js.
        // Para este exemplo, vamos assumir que os ícones são acessíveis ou que a parte do ícone é tratada no JSX.
        // Para simplificar, os ícones serão referenciados diretamente como no App.js, assumindo que o ambiente React os resolve.
        // Em um ambiente de produção real, você usaria um bundler para resolver essas importações.

        // Variáveis globais para as chaves do Supabase
        // ATENÇÃO: Substitua com suas próprias chaves do Supabase
        const SUPABASE_URL = 'https://jtikvjomzduvjrrrsfeg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0aWt2am9temR1dmpycnJzZmVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMjU3NjcsImV4cCI6MjA2ODcwMTc2N30.2SCuJprMLJROxV6r6z1xKaVnnvy-q0Edwb0DrmcNeEg';

        // Inicializa o cliente Supabase
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const App = () => {
          // Estados para o formulário de cadastro/alteração
          const [plate, setPlate] = React.useState('');
          const [branch, setBranch] = React.useState('');
          const [date, setDate] = React.useState('');

          // Estados para dados da aplicação
          const [plateData, setPlateData] = React.useState([]); // Dados de equipamentos e histórico
          const [branchesData, setBranchesData] = React.useState([]); // Dados de filiais para dropdowns/autocompletes
          const [dashboardSelectedBranch, setDashboardSelectedBranch] = React.useState(''); // Filial selecionada no dashboard

          // Estados de UI e autenticação
          const [loading, setLoading] = React.useState(true); // Indica se os dados iniciais estão sendo carregados
          const [error, setError] = React.useState(null); // Mensagens de erro globais
          const [message, setMessage] = React.useState({ text: '', type: '' }); // Mensagens de sucesso/erro/info para formulários
          const [currentView, setCurrentView] = React.useState('auth'); // Controla a seção ativa: 'auth', null (menu principal), 'cadastroEquipamento', etc.
          const [loggedInAppUser, setLoggedInAppUser] = React.useState(null); // Usuário logado no sistema personalizado
          const [currentCadastroMode, setCurrentCadastroMode] = React.useState('manual'); // 'manual' ou 'bulk' para cadastro de equipamento

          // Estados para o formulário de login
          const [loginUsername, setLoginUsername] = React.useState('');
          const [loginPassword, setLoginPassword] = React.useState('');

          // Estados para o formulário de criação de usuário (Admin)
          const [newUserName, setNewUserName] = React.useState('');
          const [newUserDisplayName, setNewUserDisplayName] = React.useState('');
          const [newUserPassword, setNewUserPassword] = React.useState('');
          const [newUserIsAdmin, setNewUserIsAdmin] = React.useState(false);
          const [createUserMessage, setCreateUserMessage] = React.useState({ text: '', type: '' });


          // --- Funções de Utilidade ---

          /**
           * Gera um hash SHA-256 de uma string.
           * @param {string} message A string para hash.
           * @returns {Promise<string>} O hash SHA-256 em formato hexadecimal.
           */
          const sha256 = React.useCallback(async (message) => {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hexHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hexHash;
          }, []);

          const MessageDisplay = ({ text, type }) => {
            if (!text) return null;
            let bgColor, textColor, IconComponent;
            switch (type) {
              case 'success':
                bgColor = 'bg-green-100';
                textColor = 'text-green-800';
                IconComponent = LucideReact.CheckCircle;
                break;
              case 'error':
                bgColor = 'bg-red-100';
                textColor = 'text-red-800';
                IconComponent = LucideReact.XCircle;
                break;
              case 'info':
                bgColor = 'bg-blue-100';
                textColor = 'text-blue-800';
                IconComponent = LucideReact.Info;
                break;
              default:
                bgColor = 'bg-gray-100';
                textColor = 'text-gray-800';
                IconComponent = LucideReact.Info;
            }
            return (
              <div className={`mt-6 p-4 flex items-center justify-center gap-2 rounded-xl text-center font-medium border shadow-md ${bgColor} ${textColor} animate-fade-in-down`}>
                {IconComponent && typeof IconComponent === 'function' && React.createElement(IconComponent, { className: "w-5 h-5" })}
                <span>{text}</span>
              </div>
            );
          };

          const formatDate = (isoDate) => {
            if (!isoDate || isoDate === 'N/A') return 'N/A';
            const dateObj = new Date(isoDate);
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const year = dateObj.getFullYear();
            return `${day}/${month}/${year}`;
          };

          const parseDateToISO = (ddmmyyyy) => {
            if (!ddmmyyyy) return '';
            const parts = ddmmyyyy.split('/');
            if (parts.length === 3) {
              return `${parts[2]}-${parts[1]}-${parts[0]}`; // Converte para YYYY-MM-DD
            }
            return ddmmyyyy; // Retorna como está se já for ISO ou inválido
          };

          // --- Funções de Interação com Supabase ---

          const fetchPlateData = React.useCallback(async () => {
            try {
              if (!loggedInAppUser) {
                setPlateData([]);
                setLoading(false);
                return;
              }

              const { data, error: fetchError } = await supabase
                .from('equipamentos')
                .select('id, placa, filial, trocas(nova_filial, data, usuario)');

              if (fetchError) throw fetchError;

              const plates = data.map(item => {
                let currentBranch = 'N/A';
                let currentStartDate = 'N/A';
                let history = [];

                if (item.trocas && item.trocas.length > 0) {
                  const sortedTrocas = item.trocas.sort((a, b) => new Date(b.data) - new Date(a.data));
                  currentBranch = sortedTrocas[0].nova_filial;
                  currentStartDate = sortedTrocas[0].data;
                  history = sortedTrocas.map(t => ({ branch: t.nova_filial, startDate: t.data, user: t.usuario }));
                } else {
                  currentBranch = item.filial;
                  currentStartDate = 'N/A';
                }

                return {
                  id: item.id,
                  plate: item.placa,
                  currentBranch: currentBranch,
                  currentStartDate: currentStartDate,
                  history: history,
                };
              });
              setPlateData(plates);
              setLoading(false);
            } catch (err) {
              console.error("Erro ao buscar dados de placas do Supabase:", err);
              setError(`Erro ao carregar dados de placas: ${err.message}. Por favor, verifique suas políticas RLS para a tabela 'equipamentos'.`);
              setLoading(false);
            }
          }, [loggedInAppUser]); // Dependência: loggedInAppUser

          const fetchBranchesData = React.useCallback(async () => {
            try {
              if (!loggedInAppUser) {
                setBranchesData([]);
                return;
              }

              const { data, error: fetchError } = await supabase
                .from('filiais')
                .select('nome');

              if (fetchError) throw fetchError;
              setBranchesData(data);
            } catch (err) {
              console.error("Erro ao buscar dados de filiais do Supabase:", err);
              setMessage({ text: `Erro ao carregar filiais: ${err.message}.`, type: 'error' });
            }
          }, [loggedInAppUser]); // Dependência: loggedInAppUser

          // --- Efeitos para Carregamento Inicial e Realtime ---

          // Carrega a biblioteca XLSX dinamicamente via CDN
          React.useEffect(() => {
            if (typeof window.XLSX === 'undefined') {
              const script = document.createElement('script');
              script.src = "https://unpkg.com/xlsx/dist/xlsx.full.min.js";
              script.async = true;
              script.onload = () => {
                console.log("Biblioteca XLSX carregada com sucesso.");
              };
              script.onerror = () => {
                console.error("Falha ao carregar a biblioteca XLSX.");
                setError("Erro ao carregar a biblioteca de exportação (XLSX). Por favor, tente novamente.");
              };
              document.body.appendChild(script);

              return () => {
                if (document.body.contains(script)) {
                  document.body.removeChild(script);
                }
              };
            }
          }, []);

          // Efeito para carregar dados quando o usuário loga ou a view muda para uma que precisa de dados
          React.useEffect(() => {
            if (loggedInAppUser) {
              fetchPlateData();
              fetchBranchesData();

              // Configura listeners de Realtime para atualizações automáticas
              const plateChanges = supabase
                .channel('public:equipamentos')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'equipamentos' }, payload => {
                  console.log('Mudança em equipamentos recebida!', payload);
                  fetchPlateData(); // Re-fetch para atualizar a lista
                })
                .subscribe();

              const branchChanges = supabase
                .channel('public:filiais')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'filiais' }, payload => {
                  console.log('Mudança em filiais recebida!', payload);
                  fetchBranchesData(); // Re-fetch para atualizar dropdowns
                })
                .subscribe();

              const trocaChanges = supabase
                .channel('public:trocas')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'trocas' }, payload => {
                  console.log('Mudança em trocas recebida!', payload);
                  fetchPlateData(); // Re-fetch para atualizar a filial atual dos equipamentos
                })
                .subscribe();

              return () => {
                plateChanges.unsubscribe();
                branchChanges.unsubscribe();
                trocaChanges.unsubscribe();
              };
            }
          }, [loggedInAppUser, fetchPlateData, fetchBranchesData]); // Dependências: loggedInAppUser e as funções de fetch

          // --- Lógica de Autenticação Personalizada ---

          const handleLogin = async (e) => {
            e.preventDefault();
            if (!loginUsername || !loginPassword) {
              setMessage({ text: "Por favor, insira seu login e senha.", type: 'info' });
              return;
            }

            try {
              // 1. Busca o usuário na tabela 'usuarios'
              const { data: userData, error: userError } = await supabase
                .from('usuarios')
                .select('id, login, display_name, senha, is_admin')
                .eq('login', loginUsername)
                .single();

              if (userError) {
                console.error("Erro ao buscar usuário na tabela 'usuarios':", userError);
                if (userError.code === 'PGRST116') { // No rows found
                  setMessage({ text: "Usuário ou senha inválidos.", type: 'error' });
                } else {
                  setMessage({ text: `Erro de comunicação com o banco de dados: ${userError.message}.`, type: 'error' });
                }
                return;
              }

              // 2. Compara o hash da senha
              const hashedPassword = await sha256(loginPassword);
              if (hashedPassword === userData.senha) {
                setLoggedInAppUser({
                  id: userData.id,
                  login: userData.login,
                  displayName: userData.display_name,
                  isAdmin: userData.is_admin || false
                });
                setMessage({ text: 'Login bem-sucedido!', type: 'success' });
                setLoginUsername('');
                setLoginPassword('');
                setCurrentView(null); // Vai para a tela principal
              } else {
                setMessage({ text: "Usuário ou senha inválidos.", type: 'error' });
              }
            } catch (err) {
              console.error("Erro geral no login:", err);
              setMessage({ text: `Erro ao tentar fazer login: ${err.message}. Por favor, tente novamente.`, type: 'error' });
            }
          };

          const handleLogout = () => {
            setLoggedInAppUser(null);
            setPlateData([]); // Limpa os dados ao deslogar
            setBranchesData([]);
            setCurrentView('auth'); // Volta para a tela de autenticação
            setMessage({ text: '', type: '' });
            setError(null);
            setLoading(false);
          };

          // --- Lógica de Formulários e Operações ---

          const handleSaveEquipment = async (e) => {
            e.preventDefault();
            if (!plate || !branch || !date) {
              setMessage({ text: "Por favor, preencha todos os campos.", type: 'info' });
              return;
            }
            if (!loggedInAppUser) {
              setMessage({ text: "Usuário não autenticado. Por favor, faça login.", type: 'error' });
              return;
            }

            setMessage({ text: '', type: '' });

            try {
              // 1. Verifica se a filial existe
              const { data: branchExists, error: branchError } = await supabase
                .from('filiais')
                .select('nome')
                .eq('nome', branch.toUpperCase())
                .single();

              if (branchError && branchError.code === 'PGRST116') {
                setMessage({ text: `Filial "${branch.toUpperCase()}" não cadastrada. Por favor, cadastre a filial primeiro.`, type: 'error' });
                return;
              } else if (branchError) {
                throw branchError;
              }

              // 2. Verifica se a placa já existe na tabela 'equipamentos'
              const { data: existingPlate, error: selectError } = await supabase
                .from('equipamentos')
                .select('id')
                .eq('placa', plate.toUpperCase())
                .single();

              if (selectError && selectError.code === 'PGRST116') { // Placa não existe, então insere novo equipamento
                const { error: insertEquipError } = await supabase
                  .from('equipamentos')
                  .insert([
                    { placa: plate.toUpperCase(), tipo: 'N/A', filial: branch.toUpperCase() }
                  ]);
                if (insertEquipError) throw insertEquipError;

                // Insere a primeira troca na tabela 'trocas'
                const { error: insertTrocaError } = await supabase
                  .from('trocas')
                  .insert([
                    {
                      placa: plate.toUpperCase(),
                      nova_filial: branch.toUpperCase(),
                      usuario: loggedInAppUser.login,
                      data: date
                    }
                  ]);
                if (insertTrocaError) throw insertTrocaError;

                setMessage({ text: `Equipamento ${plate.toUpperCase()} cadastrado com sucesso na filial ${branch.toUpperCase()}.`, type: 'success' });
                setPlate('');
                setBranch('');
                setDate('');
              } else if (selectError) {
                throw selectError;
              } else {
                // Placa já existe
                setMessage({ text: `Placa "${plate.toUpperCase()}" já cadastrada. Utilize a opção 'Alteração de Filial' para modificá-la.`, type: 'error' });
              }
            } catch (e) {
              console.error("Erro ao cadastrar equipamento:", e);
              setMessage({ text: `Erro ao cadastrar equipamento: ${e.message}. Por favor, tente novamente.`, type: 'error' });
            }
          };

          const handleAlterBranch = async (e) => {
            e.preventDefault();
            if (!plate || !branch || !date) {
              setMessage({ text: "Por favor, preencha todos os campos.", type: 'info' });
              return;
            }
            if (!loggedInAppUser) {
              setMessage({ text: "Usuário não autenticado. Por favor, faça login.", type: 'error' });
              return;
            }

            setMessage({ text: '', type: '' });

            try {
              // 1. Verifica se a nova filial existe
              const { data: branchExists, error: branchError } = await supabase
                .from('filiais')
                .select('nome')
                .eq('nome', branch.toUpperCase())
                .single();

              if (branchError && branchError.code === 'PGRST116') {
                setMessage({ text: `Nova filial "${branch.toUpperCase()}" não cadastrada. Por favor, cadastre a filial primeiro.`, type: 'error' });
                return;
              } else if (branchError) {
                throw branchError;
              }

              // 2. Verifica se a placa existe na tabela equipamentos
              const { data: equipmentData, error: equipSelectError } = await supabase
                .from('equipamentos')
                .select('id')
                .eq('placa', plate.toUpperCase())
                .single();

              if (equipSelectError && equipSelectError.code === 'PGRST116') {
                setMessage({ text: `Placa "${plate.toUpperCase()}" não encontrada. Cadastre o equipamento primeiro.`, type: 'error' });
                return;
              } else if (equipSelectError) {
                throw equipSelectError;
              }

              // 3. Insere a nova troca na tabela 'trocas'
              const { error: insertTrocaError } = await supabase
                .from('trocas')
                .insert([
                  {
                    placa: plate.toUpperCase(),
                    nova_filial: branch.toUpperCase(),
                    usuario: loggedInAppUser.login,
                    data: date
                  }
                ]);

              if (insertTrocaError) throw insertTrocaError;

              setMessage({ text: `Filial do equipamento ${plate.toUpperCase()} atualizada para ${branch.toUpperCase()} com sucesso.`, type: 'success' });
              setPlate('');
              setBranch('');
              setDate('');
            } catch (e) {
              console.error("Erro ao alterar filial:", e);
              setMessage({ text: `Erro ao alterar filial: ${e.message}. Por favor, tente novamente.`, type: 'error' });
            }
          };

          const handleRegisterBranch = async (e) => {
            e.preventDefault();
            if (!branch) {
              setMessage({ text: "Por favor, insira o nome da filial.", type: 'info' });
              return;
            }
            if (!loggedInAppUser) {
              setMessage({ text: "Usuário não autenticado. Por favor, faça login.", type: 'error' });
              return;
            }

            setMessage({ text: '', type: '' });

            try {
              // Verifica se a filial já existe
              const { data: existingBranch, error: selectError } = await supabase
                .from('filiais')
                .select('nome')
                .eq('nome', branch.toUpperCase())
                .single();

              if (selectError && selectError.code === 'PGRST116') { // Filial não existe, então insere
                const { error: insertError } = await supabase
                  .from('filiais')
                  .insert([
                    { nome: branch.toUpperCase() }
                  ]);
                if (insertError) throw insertError;

                setMessage({ text: `Filial "${branch.toUpperCase()}" cadastrada com sucesso.`, type: 'success' });
                setBranch(''); // Limpa o campo
              } else if (selectError) {
                throw selectError;
              } else {
                setMessage({ text: `Filial "${branch.toUpperCase()}" já cadastrada.`, type: 'info' });
              }
            } catch (e) {
              console.error("Erro ao cadastrar filial:", e);
              setMessage({ text: `Erro ao cadastrar filial: ${e.message}. Por favor, tente novamente.`, type: 'error' });
            }
          };

          const handleCreateUser = async (e) => {
            e.preventDefault();
            if (!newUserName || !newUserDisplayName || !newUserPassword) {
              setCreateUserMessage({ text: "Por favor, preencha todos os campos.", type: 'info' });
              return;
            }

            if (!loggedInAppUser || !loggedInAppUser.isAdmin) {
              setCreateUserMessage({ text: "Acesso negado. Você não tem permissões de administrador para criar usuários.", type: 'error' });
              return;
            }

            try {
              // Verifica se o login já existe
              const { data: existingUser, error: checkError } = await supabase
                .from('usuarios')
                .select('id')
                .eq('login', newUserName)
                .single();

              if (checkError && checkError.code === 'PGRST116') { // No rows found, so insert new user
                const hashedPassword = await sha256(newUserPassword);
                const { error: insertError } = await supabase
                  .from('usuarios')
                  .insert([
                    {
                      login: newUserName,
                      display_name: newUserDisplayName,
                      senha: hashedPassword,
                      is_admin: newUserIsAdmin
                    }
                  ]);

                if (insertError) throw insertError;

                setCreateUserMessage({ text: `Usuário "${newUserName}" criado com sucesso!`, type: 'success' });
                setNewUserName('');
                setNewUserDisplayName('');
                setNewUserPassword('');
                setNewUserIsAdmin(false);
              } else if (checkError) {
                throw checkError;
              } else {
                setCreateUserMessage({ text: `Nome de usuário "${newUserName}" já existe.`, type: 'error' });
              }
            } catch (err) {
              console.error("Erro geral ao criar usuário:", err);
              setCreateUserMessage({ text: `Erro ao criar usuário: ${err.message}.`, type: 'error' });
            }
          };

          const handleBulkUpload = async () => {
            const rawData = document.getElementById('bulk-upload-textarea').value.trim();
            if (!rawData) {
              setMessage({ text: "Por favor, cole os dados na área de texto.", type: 'info' });
              return;
            }
            if (!loggedInAppUser) {
              setMessage({ text: "Usuário não autenticado. Por favor, faça login.", type: 'error' });
              return;
            }

            const bulkUploadResultsDisplay = document.getElementById('bulk-upload-results-display');
            const bulkUploadProgressBar = document.getElementById('bulk-upload-progress');

            if (bulkUploadResultsDisplay) {
              bulkUploadResultsDisplay.innerHTML = `<p class="text-center text-blue-600">Processando... <span id="bulk-upload-progress">0%</span></p>`;
              bulkUploadResultsDisplay.style.display = 'block';
            }
            setMessage({ text: '', type: '' });

            const lines = rawData.split('\n').filter(line => line.trim() !== '');
            const totalLines = lines.length;
            let processedLines = 0;

            const results = { success: [], errors: [] };
            const newBranchesToInsert = new Set();
            const newEquipmentsToInsert = [];
            const newTrocasToInsert = [];

            // Pré-verifica filiais existentes para evitar consultas repetidas
            const { data: existingBranches, error: existingBranchesError } = await supabase
              .from('filiais')
              .select('nome');
            if (existingBranchesError) {
              console.error("Erro ao buscar filiais existentes:", existingBranchesError);
              setMessage({ text: `Erro ao preparar upload: ${existingBranchesError.message}.`, type: 'error' });
              return;
            }
            const existingBranchNames = new Set(existingBranches.map(b => b.nome));

            // Pré-verifica placas existentes
            const { data: existingEquipments, error: existingEquipmentsError } = await supabase
              .from('equipamentos')
              .select('placa');
            if (existingEquipmentsError) {
              console.error("Erro ao buscar equipamentos existentes:", existingEquipmentsError);
              setMessage({ text: `Erro ao preparar upload: ${existingEquipmentsError.message}.`, type: 'error' });
              return;
            }
            const existingPlateNames = new Set(existingEquipments.map(e => e.placa));


            for (const line of lines) {
              const parts = line.split('\t').map(p => p.trim());
              if (parts.length < 6 || parts[0].toUpperCase() !== 'PLACA' || parts[2].toUpperCase() !== 'FILIAL' || parts[4].toUpperCase() !== 'DATA') {
                results.errors.push(`Linha inválida (formato esperado: PLACA\\t[valor]\\tFILIAL\\t[valor]\\tDATA\\t[valor]): ${line}`);
                processedLines++;
                if (bulkUploadProgressBar) bulkUploadProgressBar.textContent = `${Math.floor((processedLines / totalLines) * 100)}%`;
                continue;
              }

              const plateValue = parts[1].toUpperCase();
              const branchValue = parts[3].toUpperCase();
              const dateValue = parseDateToISO(parts[5]);

              if (!plateValue || !branchValue || !dateValue) {
                results.errors.push(`Dados incompletos na linha: ${line}`);
                processedLines++;
                if (bulkUploadProgressBar) bulkUploadProgressBar.textContent = `${Math.floor((processedLines / totalLines) * 100)}%`;
                continue;
              }

              // Adiciona nova filial à lista para inserção, se não existir
              if (!existingBranchNames.has(branchValue) && !newBranchesToInsert.has(branchValue)) {
                newBranchesToInsert.add(branchValue);
              }

              // Verifica se a placa já existe
              if (!existingPlateNames.has(plateValue)) {
                newEquipmentsToInsert.push({ placa: plateValue, tipo: 'N/A', filial: branchValue }); // Assumindo tipo 'N/A'
                existingPlateNames.add(plateValue); // Adiciona à lista de placas existentes para evitar duplicatas no mesmo upload
              }

              // Adiciona a troca
              newTrocasToInsert.push({
                placa: plateValue,
                nova_filial: branchValue,
                usuario: loggedInAppUser.login,
                data: dateValue
              });

              processedLines++;
              if (bulkUploadProgressBar) bulkUploadProgressBar.textContent = `${Math.floor((processedLines / totalLines) * 100)}%`;
            }

            try {
              // Inserir novas filiais
              if (newBranchesToInsert.size > 0) {
                const branchesArray = Array.from(newBranchesToInsert).map(name => ({ nome: name }));
                const { error: insertBranchesError } = await supabase
                  .from('filiais')
                  .insert(branchesArray);
                if (insertBranchesError) throw insertBranchesError;
                branchesArray.forEach(b => results.success.push(`Filial "${b.nome}" adicionada.`));
              }

              // Inserir novos equipamentos
              if (newEquipmentsToInsert.length > 0) {
                const { error: insertEquipmentsError } = await supabase
                  .from('equipamentos')
                  .insert(newEquipmentsToInsert);
                if (insertEquipmentsError) throw insertEquipmentsError;
                newEquipmentsToInsert.forEach(e => results.success.push(`Equipamento "${e.placa}" cadastrado.`));
              }

              // Inserir todas as trocas (incluindo as de equipamentos existentes)
              if (newTrocasToInsert.length > 0) {
                const { error: insertTrocasError } = await supabase
                  .from('trocas')
                  .insert(newTrocasToInsert);
                if (insertTrocasError) throw insertTrocasError;
                newTrocasToInsert.forEach(t => results.success.push(`Troca para "${t.placa}" registrada.`));
              }

              let outputHtml = '<div><p class="font-bold text-green-700">Upload Concluído!</p>';
              if (results.success.length > 0) {
                outputHtml += `<p class="text-green-600">Sucessos (${results.success.length}):</p><ul class="list-disc list-inside">`;
                results.success.forEach(msg => outputHtml += `<li>${msg}</li>`);
                outputHtml += '</ul>';
              }
              if (results.errors.length > 0) {
                outputHtml += `<p class="font-bold text-red-700 mt-4">Erros (${results.errors.length}):</p><ul class="list-disc list-inside">`;
                results.errors.forEach(msg => outputHtml += `<li class="text-red-600">${msg}</li>`);
                outputHtml += '</ul>';
              }
              outputHtml += '</div>';
              bulkUploadResultsDisplay.innerHTML = outputHtml;
              fetchPlateData(); // Re-fetch all data to update UI
            } catch (e) {
              console.error("Erro geral ao commitar upload em massa:", e);
              bulkUploadResultsDisplay.innerHTML = `<p class="font-bold text-red-700">Erro fatal no upload em massa: ${e.message}</p>`;
            }
          };


          const exportToExcel = React.useCallback(() => {
            if (typeof window.XLSX === 'undefined') {
              setMessage({ text: "A biblioteca de exportação (XLSX) ainda não foi carregada. Por favor, aguarde e tente novamente.", type: 'info' });
              return;
            }

            const dataToExport = plateData.map(item => ({
              'PLACA': item.plate,
              'FILIAL': item.currentBranch,
              'DATA': formatDate(item.currentStartDate)
            }));

            const ws = window.XLSX.utils.json_to_sheet(dataToExport);
            const wb = window.XLSX.utils.book_new();
            window.XLSX.utils.book_append_sheet(wb, ws, "Placas e Filiais");
            window.XLSX.writeFile(wb, "Placas_e_Filiais.xlsx");
          }, [plateData]);

          // --- Funções de Autocomplete ---
          const setupAutocomplete = React.useCallback((inputElementId, suggestionsContainerId, dataArray, keyField) => {
            const inputElement = document.getElementById(inputElementId);
            const suggestionsContainer = document.getElementById(suggestionsContainerId);

            if (!inputElement || !suggestionsContainer) return;

            const handleInput = () => {
              const inputValue = inputElement.value.trim().toUpperCase();
              suggestionsContainer.innerHTML = '';
              suggestionsContainer.style.display = 'none';

              if (inputValue.length === 0) {
                return;
              }

              const filteredData = dataArray.filter(item => {
                const valueToMatch = typeof item === 'string' ? item : item[keyField];
                return valueToMatch.toUpperCase().includes(inputValue);
              });

              if (filteredData.length > 0) {
                filteredData.forEach(item => {
                  const suggestionValue = typeof item === 'string' ? item : item[keyField];
                  const suggestionItem = document.createElement('div');
                  suggestionItem.classList.add('p-2', 'cursor-pointer', 'hover:bg-blue-100', 'border-b', 'border-gray-200', 'last:border-b-0');
                  suggestionItem.textContent = suggestionValue;
                  suggestionItem.addEventListener('click', () => {
                    inputElement.value = suggestionValue;
                    // Atualiza o estado do React correspondente
                    if (inputElementId === 'cadastro-equipamento-plate' || inputElementId === 'alteracao-filial-plate') setPlate(suggestionValue);
                    if (inputElementId === 'cadastro-equipamento-branch' || inputElementId === 'alteracao-filial-branch' || inputElementId === 'cadastro-filial-name') setBranch(suggestionValue);
                    suggestionsContainer.style.display = 'none';
                  });
                  suggestionsContainer.appendChild(suggestionItem);
                });
                suggestionsContainer.style.display = 'block';
              }
            };

            const handleBlur = () => {
              setTimeout(() => {
                suggestionsContainer.style.display = 'none';
              }, 100);
            };

            inputElement.addEventListener('input', handleInput);
            inputElement.addEventListener('blur', handleBlur);

            return () => {
              inputElement.removeEventListener('input', handleInput);
              inputElement.removeEventListener('blur', handleBlur);
            };
          }, []); // Sem dependências para que a função seja estável e não recrie listeners desnecessariamente

          // Efeitos para configurar autocompletes quando os dados são carregados
          React.useEffect(() => {
            if (plateData.length > 0) {
              setupAutocomplete('cadastro-equipamento-plate', 'plate-suggestions-cadastro', plateData, 'plate');
              setupAutocomplete('alteracao-filial-plate', 'plate-suggestions-alteracao', plateData, 'plate');
            }
          }, [plateData, setupAutocomplete]);

          React.useEffect(() => {
            if (branchesData.length > 0) {
              setupAutocomplete('cadastro-equipamento-branch', 'branch-suggestions-cadastro', branchesData, 'nome');
              setupAutocomplete('alteracao-filial-branch', 'branch-suggestions-alteracao', branchesData, 'nome');
              setupAutocomplete('cadastro-filial-name', 'branch-suggestions-cadastro-filial', branchesData, 'nome'); // Adicionado para cadastro de filial
            }
          }, [branchesData, setupAutocomplete]);


          // Renderização condicional da UI
          if (loading && loggedInAppUser) { // Apenas mostra loading se o usuário já estiver logado e dados estiverem sendo buscados
            return (
              <div className="flex items-center justify-center min-h-screen bg-gray-50">
                <div className="text-xl font-semibold text-gray-700 animate-pulse">Carregando dados...</div>
              </div>
            );
          }

          if (error) { // Erro global
            return (
              <div className="flex items-center justify-center min-h-screen bg-red-50 text-red-800 p-6 rounded-lg shadow-lg">
                {React.createElement(LucideReact.XCircle, { className: "w-6 h-6 mr-3" })}
                <span className="font-medium">{error}</span>
              </div>
            );
          }

          // Renderiza a tela de login se não houver usuário logado
          if (!loggedInAppUser) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 p-4 sm:p-6 flex flex-col items-center justify-center">
                <div className="w-full max-w-4xl bg-white shadow-xl rounded-2xl p-6 sm:p-10 mb-8 transition-all duration-300 ease-in-out transform hover:scale-[1.005]">
                  <h1 className="text-4xl sm:text-5xl font-extrabold text-gray-900 mb-8 text-center bg-clip-text text-transparent bg-gradient-to-r from-blue-700 to-indigo-800">
                    Gerenciamento de Placas e Filiais
                  </h1>
                  <div id="auth-section" className="flex flex-col items-center justify-center gap-6 mb-8">
                    <h2 className="text-3xl font-bold text-gray-800 text-center">Acessar o Sistema</h2>
                    <p className="text-gray-600 text-center text-lg leading-relaxed max-w-2xl">
                      Faça login para continuar.
                    </p>
                    <form onSubmit={handleLogin} className="w-full max-w-sm p-6 bg-gray-50 rounded-lg shadow-inner">
                      <h3 className="text-2xl font-semibold text-gray-800 mb-4 text-center">Login</h3>
                      <div className="mb-4">
                        <label htmlFor="login-username-input" className="block text-sm font-medium text-gray-700 mb-2">Usuário (Login)</label>
                        <input
                          type="text"
                          id="login-username-input"
                          className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out hover:border-blue-400"
                          placeholder="seu.login"
                          value={loginUsername}
                          onChange={(e) => setLoginUsername(e.target.value)}
                          required
                        />
                      </div>
                      <div className="mb-6">
                        <label htmlFor="login-password" className="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                        <input
                          type="password"
                          id="login-password"
                          className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out hover:border-blue-400"
                          placeholder="********"
                          value={loginPassword}
                          onChange={(e) => setLoginPassword(e.target.value)}
                          required
                        />
                      </div>
                      <button type="submit"
                        className="w-full px-8 py-3 bg-gradient-to-r from-blue-600 to-indigo-700 text-white font-bold rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105">
                        Entrar
                      </button>
                      <MessageDisplay text={message.text} type={message.type} />
                    </form>
                  </div>
                </div>
              </div>
            );
          }

          // Renderiza a UI principal após o login
          return (
            <div className="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 p-4 sm:p-6 font-sans flex flex-col items-center justify-center">
              <div className="w-full max-w-4xl bg-white shadow-xl rounded-2xl p-6 sm:p-10 mb-8 transition-all duration-300 ease-in-out transform hover:scale-[1.005]">
                <h1 className="text-4xl sm:text-5xl font-extrabold text-gray-900 mb-8 text-center bg-clip-text text-transparent bg-gradient-to-r from-blue-700 to-indigo-800">
                  Gerenciamento de Placas e Filiais
                </h1>

                {/* Barra de Informação do Usuário Logado e Botão de Sair */}
                <div className="flex justify-between items-center mb-6 p-3 bg-gray-50 rounded-lg shadow-sm">
                  <p className="text-gray-700 font-semibold">Usuário: <span id="current-user-display" className="text-blue-700">{loggedInAppUser.displayName || loggedInAppUser.login}</span></p>
                  <button onClick={handleLogout}
                    className="px-4 py-2 bg-red-200 text-red-700 rounded-lg font-semibold hover:bg-red-300 transition-colors duration-200 shadow-sm">
                    Sair
                  </button>
                </div>

                {/* Seção de Botões de Navegação Inicial */}
                {currentView === null && (
                  <div className="flex flex-col gap-4 mb-8">
                    <button
                      className="flex items-center justify-center px-8 py-4 rounded-xl font-bold text-lg shadow-md transition-all duration-300 ease-in-out transform hover:scale-105 bg-gradient-to-r from-blue-600 to-indigo-700 text-white hover:bg-blue-700"
                      onClick={() => { setCurrentView('cadastroEquipamento'); setMessage({text:'', type:''}); setPlate(''); setBranch(''); setDate(''); }}
                    >
                      {React.createElement(LucideReact.CheckCircle, { className: "w-6 h-6 mr-3" })} CADASTRO DE EQUIPAMENTO
                    </button>
                    <button
                      className="flex items-center justify-center px-8 py-4 rounded-xl font-bold text-lg shadow-md transition-all duration-300 ease-in-out transform hover:scale-105 bg-gradient-to-r from-blue-600 to-indigo-700 text-white hover:bg-blue-700"
                      onClick={() => { setCurrentView('alteracaoFilial'); setMessage({text:'', type:''}); setPlate(''); setBranch(''); setDate(''); }}
                    >
                      {React.createElement(LucideReact.HardHat, { className: "w-6 h-6 mr-3" })} ALTERAÇÃO DE FILIAL
                    </button>
                    <button
                      className="flex items-center justify-center px-8 py-4 rounded-xl font-bold text-lg shadow-md transition-all duration-300 ease-in-out transform hover:scale-105 bg-gradient-to-r from-blue-600 to-indigo-700 text-white hover:bg-blue-700"
                      onClick={() => { setCurrentView('cadastroFilial'); setMessage({text:'', type:''}); setBranch(''); }}
                    >
                      {React.createElement(LucideReact.Briefcase, { className: "w-6 h-6 mr-3" })} CADASTRO DE FILIAL
                    </button>
                    <button
                      className="flex items-center justify-center px-8 py-4 rounded-xl font-bold text-lg shadow-md transition-all duration-300 ease-in-out transform hover:scale-105 bg-gradient-to-r from-blue-600 to-indigo-700 text-white hover:bg-blue-700"
                      onClick={() => { setCurrentView('dashboard'); setMessage({text:'', type:''}); setDashboardSelectedBranch(''); }}
                    >
                      {React.createElement(LucideReact.Info, { className: "w-6 h-6 mr-3" })} DASHBOARD
                    </button>
                    {loggedInAppUser && loggedInAppUser.isAdmin && (
                      <button
                        className="flex items-center justify-center px-8 py-4 rounded-xl font-bold text-lg shadow-md transition-all duration-300 ease-in-out transform hover:scale-105 bg-gradient-to-r from-purple-600 to-pink-700 text-white hover:bg-purple-700"
                        onClick={() => { setCurrentView('adminPanel'); setCreateUserMessage({text:'', type:''}); setNewUserName(''); setNewUserDisplayName(''); setNewUserPassword(''); setNewUserIsAdmin(false); }}
                      >
                        {React.createElement(LucideReact.Info, { className: "w-6 h-6 mr-3" })} ADMINISTRAÇÃO
                      </button>
                    )}
                    <button
                        className="flex items-center justify-center px-8 py-4 rounded-xl font-bold text-lg shadow-md transition-all duration-300 ease-in-out transform hover:scale-105 bg-gradient-to-r from-teal-600 to-cyan-700 text-white hover:bg-teal-700"
                        onClick={() => { setCurrentView('urlTransformation'); setMessage({text:'', type:''}); }}
                    >
                        {React.createElement(LucideReact.Info, { className: "w-6 h-6 mr-3" })} TRANSFORMAÇÃO DE URL
                    </button>
                  </div>
                )}

                {/* Conteúdo da Seção: CADASTRO DE EQUIPAMENTO */}
                {currentView === 'cadastroEquipamento' && (
                  <div className="mt-8 p-6 bg-white rounded-xl shadow-md border border-gray-100 flex flex-col items-center">
                    <h2 className="text-3xl font-bold text-gray-800 mb-6 text-center">Cadastro de Equipamento</h2>
                    <p className="text-gray-600 text-center mb-8 text-lg leading-relaxed max-w-2xl">
                      Utilize esta seção para registrar novos equipamentos com sua placa, filial e data inicial.
                    </p>

                    <div className="flex gap-4 mb-6">
                      <button
                        onClick={() => setCurrentCadastroMode('manual')}
                        className={`px-6 py-2 rounded-lg font-semibold transition-all duration-200 ${currentCadastroMode === 'manual' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                      >
                        {React.createElement(LucideReact.Info, { className: "w-5 h-5 mr-2" })}
                        Cadastro Manual
                      </button>
                      <button
                        onClick={() => setCurrentCadastroMode('bulk')}
                        className={`px-6 py-2 rounded-lg font-semibold transition-all duration-200 ${currentCadastroMode === 'bulk' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                      >
                        {React.createElement(LucideReact.Info, { className: "w-5 h-5 mr-2" })}
                        Upload em Massa
                      </button>
                    </div>

                    {/* Formulário de Cadastro Manual */}
                    {currentCadastroMode === 'manual' && (
                      <form onSubmit={handleSaveEquipment} className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 w-full max-w-2xl">
                        <div>
                          <label htmlFor="cadastro-equipamento-plate" className="block text-sm font-medium text-gray-700 mb-2">PLACA</label>
                          <input
                            type="text"
                            id="cadastro-equipamento-plate"
                            value={plate}
                            onChange={(e) => setPlate(e.target.value)}
                            className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out hover:border-blue-400 uppercase"
                            placeholder="Ex: ABC1234"
                            required
                          />
                          <div id="plate-suggestions-cadastro" className="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-40 overflow-y-auto" style={{display: 'none'}}></div>
                        </div>
                        <div>
                          <label htmlFor="cadastro-equipamento-branch" className="block text-sm font-medium text-gray-700 mb-2">FILIAL (Sigla)</label>
                          <input
                            type="text"
                            id="cadastro-equipamento-branch"
                            value={branch}
                            onChange={(e) => setBranch(e.target.value)}
                            className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out hover:border-blue-400 uppercase"
                            placeholder="Ex: IPA"
                            required
                          />
                          <div id="branch-suggestions-cadastro" className="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-40 overflow-y-auto" style={{display: 'none'}}></div>
                        </div>
                        <div>
                          <label htmlFor="cadastro-equipamento-date" className="block text-sm font-medium text-gray-700 mb-2">DATA</label>
                          <input
                            type="date"
                            id="cadastro-equipamento-date"
                            value={date}
                            onChange={(e) => setDate(e.target.value)}
                            className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out hover:border-blue-400"
                            required
                          />
                        </div>
                        <div className="md:col-span-3 flex justify-center mt-4">
                          <button type="submit"
                            className="w-full md:w-auto px-8 py-3 bg-gradient-to-r from-blue-600 to-indigo-700 text-white font-bold rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105">
                            Cadastrar Equipamento
                          </button>
                        </div>
                      </form>
                    )}

                    {/* Formulário de Upload em Massa */}
                    {currentCadastroMode === 'bulk' && (
                      <div className="w-full max-w-2xl">
                        <label htmlFor="bulk-upload-textarea" className="block text-sm font-medium text-gray-700 mb-2">Cole os dados aqui (uma linha por equipamento, separados por TAB: PLACA &lt;tab&gt; FILIAL &lt;tab&gt; DATA)</label>
                        <textarea id="bulk-upload-textarea" rows="10"
                          className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out hover:border-blue-400"
                          placeholder="Ex:&#10;PLACA	ABC1234	FILIAL	IPA	DATA	15/07/2025&#10;PLACA	XYZ5678	FILIAL	SP	DATA	20/03/2023"></textarea>
                        <div className="flex justify-center mt-4">
                          <button onClick={handleBulkUpload}
                            className="w-full md:w-auto px-8 py-3 bg-gradient-to-r from-green-600 to-emerald-700 text-white font-bold rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105">
                            Processar Upload
                          </button>
                        </div>
                        <div id="bulk-upload-results-display" className="mt-6 p-4 bg-gray-50 rounded-lg shadow-inner text-sm text-gray-700" style={{display: 'none'}}>
                          {/* Resultados do upload em massa serão exibidos aqui */}
                          <p className="text-center text-blue-600">Processando... <span id="bulk-upload-progress">0%</span></p>
                        </div>
                      </div>
                    )}

                    <MessageDisplay text={message.text} type={message.type} />
                    <button
                      onClick={() => setCurrentView(null)}
                      className="mt-8 flex items-center px-6 py-2 bg-gray-100 text-gray-600 rounded-lg font-semibold hover:bg-gray-200 transition-colors duration-200 shadow-sm"
                    >
                      {React.createElement(LucideReact.ArrowLeft, { className: "w-5 h-5 mr-2" })} Voltar
                    </button>
                  </div>
                )}

                {/* Conteúdo da Seção: ALTERAÇÃO DE FILIAL */}
                {currentView === 'alteracaoFilial' && (
                  <div className="mt-8 p-6 bg-white rounded-xl shadow-md border border-gray-100 flex flex-col items-center">
                    <h2 className="text-3xl font-bold text-gray-800 mb-6 text-center">Alteração de Filial</h2>
                    <p className="text-gray-600 text-center mb-8 text-lg leading-relaxed max-w-2xl">
                      Atualize a filial de um equipamento existente. A placa deve estar previamente cadastrada.
                    </p>
                    <form onSubmit={handleAlterBranch} className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 w-full max-w-2xl">
                      <div>
                        <label htmlFor="alteracao-filial-plate" className="block text-sm font-medium text-gray-700 mb-2">PLACA</label>
                        <input
                          type="text"
                          id="alteracao-filial-plate"
                          value={plate}
                          onChange={(e) => setPlate(e.target.value)}
                          className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out hover:border-blue-400 uppercase"
                          placeholder="Ex: ABC1234"
                          required
                        />
                        <div id="plate-suggestions-alteracao" className="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-40 overflow-y-auto" style={{display: 'none'}}></div>
                      </div>
                      <div>
                        <label htmlFor="alteracao-filial-branch" className="block text-sm font-medium text-gray-700 mb-2">NOVA FILIAL (Sigla)</label>
                        <input
                          type="text"
                          id="alteracao-filial-branch"
                          value={branch}
                          onChange={(e) => setBranch(e.target.value)}
                          className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out hover:border-blue-400 uppercase"
                          placeholder="Ex: SP"
                          required
                        />
                        <div id="branch-suggestions-alteracao" className="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-40 overflow-y-auto" style={{display: 'none'}}></div>
                      </div>
                      <div>
                        <label htmlFor="alteracao-filial-date" className="block text-sm font-medium text-gray-700 mb-2">DATA DA ALTERAÇÃO</label>
                        <input
                          type="date"
                          id="alteracao-filial-date"
                          value={date}
                          onChange={(e) => setDate(e.target.value)}
                          className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out hover:border-blue-400"
                          required
                        />
                      </div>
                      <div className="md:col-span-3 flex justify-center mt-4">
                        <button type="submit"
                          className="w-full md:w-auto px-8 py-3 bg-gradient-to-r from-blue-600 to-indigo-700 text-white font-bold rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105">
                          Alterar Filial
                        </button>
                      </div>
                    </form>
                    <MessageDisplay text={message.text} type={message.type} />
                    <button
                      onClick={() => setCurrentView(null)}
                      className="mt-8 flex items-center px-6 py-2 bg-gray-100 text-gray-600 rounded-lg font-semibold hover:bg-gray-200 transition-colors duration-200 shadow-sm"
                    >
                      {React.createElement(LucideReact.ArrowLeft, { className: "w-5 h-5 mr-2" })} Voltar
                    </button>
                  </div>
                )}

                {/* Conteúdo da Seção: CADASTRO DE FILIAL */}
                {currentView === 'cadastroFilial' && (
                  <div className="mt-8 p-6 bg-white rounded-xl shadow-md border border-gray-100 flex flex-col items-center">
                    <h2 className="text-3xl font-bold text-gray-800 mb-6 text-center">Cadastro de Filial</h2>
                    <p className="text-gray-600 text-center mb-8 text-lg leading-relaxed max-w-2xl">
                      Registre novas filiais no sistema para que possam ser utilizadas no cadastro e alteração de equipamentos.
                    </p>
                    <form onSubmit={handleRegisterBranch} className="grid grid-cols-1 gap-6 mb-8 w-full max-w-md">
                      <div>
                        <label htmlFor="cadastro-filial-name" className="block text-sm font-medium text-gray-700 mb-2">NOME DA FILIAL (Sigla)</label>
                        <input
                          type="text"
                          id="cadastro-filial-name"
                          value={branch}
                          onChange={(e) => setBranch(e.target.value)}
                          className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out hover:border-blue-400 uppercase"
                          placeholder="Ex: ITA"
                          required
                        />
                        <div id="branch-suggestions-cadastro-filial" className="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-40 overflow-y-auto" style={{display: 'none'}}></div>
                      </div>
                      <div className="flex justify-center mt-4">
                        <button type="submit"
                          className="w-full md:w-auto px-8 py-3 bg-gradient-to-r from-blue-600 to-indigo-700 text-white font-bold rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105">
                          Cadastrar Filial
                        </button>
                      </div>
                    </form>
                    <MessageDisplay text={message.text} type={message.type} />
                    <button
                      onClick={() => setCurrentView(null)}
                      className="mt-8 flex items-center px-6 py-2 bg-gray-100 text-gray-600 rounded-lg font-semibold hover:bg-gray-200 transition-colors duration-200 shadow-sm"
                    >
                      {React.createElement(LucideReact.ArrowLeft, { className: "w-5 h-5 mr-2" })} Voltar
                    </button>
                  </div>
                )}

                {/* Conteúdo da Seção: DASHBOARD */}
                {currentView === 'dashboard' && (
                  <div className="mt-8 p-6 bg-white rounded-xl shadow-md border border-gray-100 flex flex-col items-center">
                    <h2 className="text-3xl font-bold text-gray-800 mb-6 text-center">Dashboard de Equipamentos por Filial</h2>
                    <p className="text-gray-600 text-center mb-8 text-lg leading-relaxed max-w-2xl">
                      Selecione uma filial para visualizar a quantidade de equipamentos e suas respectivas placas.
                    </p>
                    <div className="w-full max-w-md mb-8">
                      <label htmlFor="dashboard-branch-select" className="block text-sm font-medium text-gray-700 mb-2">SELECIONE A FILIAL</label>
                      <select id="dashboard-branch-select"
                        value={dashboardSelectedBranch}
                        onChange={(e) => setDashboardSelectedBranch(e.target.value)}
                        className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out hover:border-blue-400">
                        <option value="">-- Selecione uma Filial --</option>
                        {branchesData.map(branchItem => (
                          <option key={branchItem.nome} value={branchItem.nome}>{branchItem.nome}</option>
                        ))}
                      </select>
                    </div>

                    {dashboardSelectedBranch && (
                      <div id="dashboard-results" className="w-full max-w-2xl bg-gray-50 p-6 rounded-lg shadow-inner text-center">
                        <h3 className="text-2xl font-semibold text-gray-800 mb-4">
                          {dashboardSelectedBranch} - {plateData.filter(item => item.currentBranch === dashboardSelectedBranch).length} Equipamentos
                        </h3>
                        <ul id="dashboard-equipment-list" className="list-disc list-inside text-gray-700 text-left space-y-1">
                          {plateData.filter(item => item.currentBranch === dashboardSelectedBranch).length === 0 ? (
                            <li className="text-gray-500">Nenhum equipamento encontrado para esta filial.</li>
                          ) : (
                            plateData.filter(item => item.currentBranch === dashboardSelectedBranch).map(item => (
                              <li key={item.id}>{item.plate}</li>
                            ))
                          )}
                        </ul>
                      </div>
                    )}
                    <MessageDisplay text={message.text} type={message.type} />
                    <button
                      onClick={exportToExcel}
                      className="mt-6 px-8 py-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105"
                    >
                      Baixar para Excel
                    </button>
                    <button
                      onClick={() => setCurrentView(null)}
                      className="mt-8 flex items-center px-6 py-2 bg-gray-100 text-gray-600 rounded-lg font-semibold hover:bg-gray-200 transition-colors duration-200 shadow-sm"
                    >
                      {React.createElement(LucideReact.ArrowLeft, { className: "w-5 h-5 mr-2" })} Voltar
                    </button>
                  </div>
                )}

                {/* Seção de Administração */}
                {currentView === 'adminPanel' && loggedInAppUser && loggedInAppUser.isAdmin && (
                  <div className="mt-8 p-6 bg-white rounded-xl shadow-md border border-gray-100 flex flex-col items-center">
                    <h2 className="text-3xl font-bold text-gray-800 mb-6 text-center">Painel de Administração</h2>
                    <p className="text-gray-600 text-center mb-8 text-lg leading-relaxed max-w-2xl">
                      Ferramentas administrativas para gerenciar usuários.
                    </p>
                    
                    {/* Formulário para Criar Novo Usuário */}
                    <form onSubmit={handleCreateUser} className="w-full max-w-md p-6 bg-gray-50 rounded-lg shadow-inner mb-6">
                      <h3 className="text-2xl font-semibold text-gray-800 mb-4 text-center">Criar Novo Usuário</h3>
                      <div className="mb-4">
                        <label htmlFor="new-user-username" className="block text-sm font-medium text-gray-700 mb-2">Nome de Usuário (Login)</label>
                        <input
                          type="text"
                          id="new-user-username"
                          className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out hover:border-blue-400"
                          placeholder="nome.usuario"
                          value={newUserName}
                          onChange={(e) => setNewUserName(e.target.value)}
                          required
                        />
                      </div>
                      <div className="mb-4">
                        <label htmlFor="new-user-display-name" className="block text-sm font-medium text-gray-700 mb-2">Nome de Exibição</label>
                        <input
                          type="text"
                          id="new-user-display-name"
                          className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out hover:border-blue-400"
                          placeholder="Nome para exibir (ex: João Silva)"
                          value={newUserDisplayName}
                          onChange={(e) => setNewUserDisplayName(e.target.value)}
                          required
                        />
                      </div>
                      <div className="mb-6">
                        <label htmlFor="new-user-password" className="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                        <input
                          type="password"
                          id="new-user-password"
                          className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out hover:border-blue-400"
                          placeholder="********"
                          value={newUserPassword}
                          onChange={(e) => setNewUserPassword(e.target.value)}
                          required
                        />
                      </div>
                      <div className="mb-6 flex items-center">
                        <input type="checkbox" id="new-user-is-admin"
                          checked={newUserIsAdmin}
                          onChange={(e) => setNewUserIsAdmin(e.target.checked)}
                          className="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                        />
                        <label htmlFor="new-user-is-admin" className="ml-2 block text-sm text-gray-900">É Administrador?</label>
                      </div>
                      <button type="submit"
                        className="w-full px-8 py-3 bg-gradient-to-r from-green-600 to-emerald-700 text-white font-bold rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105">
                        Criar Usuário
                      </button>
                      <MessageDisplay text={createUserMessage.text} type={createUserMessage.type} />
                    </form>

                    <div className="mt-8 p-4 bg-yellow-100 text-yellow-800 rounded-lg shadow-inner text-sm">
                        <p className="font-semibold">Nota:</p>
                        <p>A redefinição de senha para outros usuários não está disponível diretamente no cliente por razões de segurança. Geralmente, isso é feito através de um fluxo de e-mail de redefinição de senha ou por ferramentas de administração de backend.</p>
                    </div>

                    <button
                      onClick={() => setCurrentView(null)}
                      className="mt-8 flex items-center px-6 py-2 bg-gray-100 text-gray-600 rounded-lg font-semibold hover:bg-gray-200 transition-colors duration-200 shadow-sm"
                    >
                      {React.createElement(LucideReact.ArrowLeft, { className: "w-5 h-5 mr-2" })} Voltar
                    </button>
                  </div>
                )}
                
                {/* Conteúdo da Seção: URL Transformation (Placeholder) */}
                {currentView === 'urlTransformation' && (
                  <div className="mt-8 p-6 bg-white rounded-xl shadow-md border border-gray-100 flex flex-col items-center">
                      <h2 className="text-3xl font-bold text-gray-800 mb-6 text-center">Transformação de URL</h2>
                      <p className="text-gray-600 text-center mb-8 text-lg leading-relaxed max-w-2xl">
                          Esta é a seção para a funcionalidade de transformação de URL. Você pode adicionar seu formulário e lógica aqui.
                      </p>
                      <MessageDisplay text={message.text} type={message.type} />
                      <button
                          onClick={() => setCurrentView(null)}
                          className="mt-8 flex items-center px-6 py-2 bg-gray-100 text-gray-600 rounded-lg font-semibold hover:bg-gray-200 transition-colors duration-200 shadow-sm"
                      >
                          {React.createElement(LucideReact.ArrowLeft, { className: "w-5 h-5 mr-2" })} Voltar
                      </button>
                  </div>
                )}
              </div>
            </div>
          );
        };

        // Renderiza o componente App no elemento com id 'root'
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
